<script>
    // ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
    const CONFIG = {
        SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzddX7gahaDxhZDkmCuqhFAYtTWRJ3A7xFoz50SzSyu3fdbJy1VLhJ3SX4ULm0wgL9M8w/exec',
        REFRESH_INTERVAL: 10000,
        VERSION: '2.0'
    };

    // ================= –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =================
    let currentState = {
        team: null,
        isAdmin: false,
        allTeams: [],
        rating: [],
        transactions: [],
        currentUser: null
    };

    // ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
        const savedTeam = localStorage.getItem('currentTeam');
        const savedAdmin = localStorage.getItem('isAdmin');
        const savedUser = localStorage.getItem('currentUser');
        
        if (savedTeam) {
            currentState.team = JSON.parse(savedTeam);
            showScreen('teamScreen');
            loadTeamData();
            startAutoRefresh();
        } else if (savedAdmin === 'true' && savedUser) {
            currentState.isAdmin = true;
            currentState.currentUser = JSON.parse(savedUser);
            showScreen('adminScreen');
            loadAdminData();
            startAutoRefresh();
        }
    });

    // ================= –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø =================
    async function loginAsTeam() {
        const code = document.getElementById('teamCode').value.trim().toUpperCase();
        
        if (!code) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            console.log('–ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã —Å –∫–æ–¥–æ–º:', code);
            const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeamByCode&code=${encodeURIComponent(code)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success && result.data.team) {
                currentState.team = result.data.team;
                localStorage.setItem('currentTeam', JSON.stringify(currentState.team));
                showScreen('teamScreen');
                loadTeamData();
                startAutoRefresh();
                showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentState.team.name}!`, 'success');
            } else {
                showNotification(result.data?.error || '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function loginAsAdmin() {
        const password = document.getElementById('adminPassword').value;
        
        if (!password) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
            
            // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const formData = new FormData();
            formData.append('action', 'checkPassword');
            formData.append('password', password);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ multipart/form-data (Google Apps Script –ª—É—á—à–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç)
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', result);
            
            if (result.success && result.data.valid) {
                currentState.isAdmin = true;
                currentState.currentUser = {
                    name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    role: 'admin',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('isAdmin', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentState.currentUser));
                
                showScreen('adminScreen');
                loadAdminData();
                startAutoRefresh();
                
                showNotification('–ü–∞–Ω–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞', 'success');
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
                document.getElementById('adminPassword').value = '';
                
            } else {
                showNotification(result.data?.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function logout() {
        currentState.team = null;
        currentState.isAdmin = false;
        currentState.currentUser = null;
        
        localStorage.removeItem('currentTeam');
        localStorage.removeItem('isAdmin');
        localStorage.removeItem('currentUser');
        
        stopAutoRefresh();
        showScreen('loginScreen');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.getElementById('teamCode').value = '';
        document.getElementById('adminPassword').value = '';
        
        showNotification('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
    }

    // ================= –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• =================
    async function loadTeamData() {
        if (!currentState.team) return;
        
        showLoading(true);
        
        try {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥—ã...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
            const ratingResponse = await fetch(`${CONFIG.SCRIPT_URL}?action=getRating`);
            if (!ratingResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞');
            
            const ratingResult = await ratingResponse.json();
            console.log('–†–µ–π—Ç–∏–Ω–≥:', ratingResult);
            
            if (ratingResult.success) {
                currentState.rating = ratingResult.data.rating;
                updateTeamDashboard();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            const historyResponse = await fetch(`${CONFIG.SCRIPT_URL}?action=getTransactions&teamId=${currentState.team.id}`);
            if (!historyResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
            
            const historyResult = await historyResponse.json();
            console.log('–ò—Å—Ç–æ—Ä–∏—è:', historyResult);
            
            if (historyResult.success) {
                currentState.transactions = historyResult.data.transactions || [];
                updateHistoryTable();
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function loadAdminData() {
        showLoading(true);
        
        try {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
            const teamsResponse = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeams`);
            if (!teamsResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥');
            
            const teamsResult = await teamsResponse.json();
            console.log('–ö–æ–º–∞–Ω–¥—ã:', teamsResult);
            
            if (teamsResult.success) {
                currentState.allTeams = teamsResult.data.teams || [];
                updateAdminTables();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            const transResponse = await fetch(`${CONFIG.SCRIPT_URL}?action=getTransactions`);
            if (!transResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
            
            const transResult = await transResponse.json();
            console.log('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', transResult);
            
            if (transResult.success) {
                updateRecentTransactions(transResult.data.transactions || []);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        } finally {
            showLoading(false);
        }
    }

    // ================= –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =================
    function updateTeamDashboard() {
        if (!currentState.team) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('teamNameDisplay').textContent = currentState.team.name;
        document.getElementById('teamScoreDisplay').textContent = `${currentState.team.score || 0} –±–∞–ª–ª–æ–≤`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('myScore').textContent = currentState.team.score || 0;
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
        let position = 0;
        if (currentState.rating && currentState.rating.length > 0) {
            position = currentState.rating.findIndex(team => team.id === currentState.team.id) + 1;
            if (position === 0) position = currentState.rating.length + 1;
        }
        
        document.getElementById('myPosition').textContent = position > 0 ? position : '-';
        document.getElementById('totalTeams').textContent = currentState.rating ? currentState.rating.length : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–π—Ç–∏–Ω–≥–∞
        updateRatingTable();
    }

    function updateHistoryTable() {
        const container = document.getElementById('historyTable');
        
        if (!currentState.transactions || currentState.transactions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>–í—Ä–µ–º—è</th><th>–ë–∞–ª–ª—ã</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–ö—Ç–æ –Ω–∞—á–∏—Å–ª–∏–ª</th></tr></thead><tbody>';
        
        currentState.transactions.slice(0, 10).forEach(trans => {
            const time = trans.timestamp ? 
                new Date(trans.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                }) : '--:--';
            
            const pointsClass = trans.points > 0 ? 'badge-success' : 'badge-danger';
            const pointsSign = trans.points > 0 ? '+' : '';
            
            html += `
                <tr>
                    <td>${time}</td>
                    <td><span class="badge ${pointsClass}">${pointsSign}${trans.points || 0}</span></td>
                    <td>${trans.reason || ''}</td>
                    <td>${trans.moderator || ''}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function updateRatingTable() {
        const container = document.getElementById('ratingTable');
        
        if (!currentState.rating || currentState.rating.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-trophy"></i>
                    <p>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–∫–∞ –ø—É—Å—Ç</p>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–ë–∞–ª–ª—ã</th><th>–û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ</th></tr></thead><tbody>';
        
        currentState.rating.forEach((team, index) => {
            const isCurrent = currentState.team && team.id === currentState.team.id;
            const rowClass = isCurrent ? 'style="background-color: #e3f2fd;"' : '';
            const medal = index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `${index + 1}.`;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –æ—Ç –ª–∏–¥–µ—Ä–∞
            const leaderScore = currentState.rating[0].score || 0;
            const gap = leaderScore - (team.score || 0);
            
            html += `
                <tr ${rowClass}>
                    <td><strong>${medal}</strong></td>
                    <td>${team.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} ${isCurrent ? '<span class="badge badge-warning">–í—ã</span>' : ''}</td>
                    <td><strong>${team.score || 0}</strong></td>
                    <td>${gap > 0 ? `-${gap}` : '–õ–∏–¥–µ—Ä'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function updateAdminTables() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
        const tbody = document.getElementById('teamsTableBody');
        const quickSelect = document.getElementById('quickTeamSelect');
        const manualSelect = document.getElementById('manualTeamSelect');
        
        tbody.innerHTML = '';
        quickSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
        manualSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
        
        if (!currentState.allTeams || currentState.allTeams.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –∫–æ–º–∞–Ω–¥</td></tr>';
            return;
        }
        
        currentState.allTeams.forEach(team => {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${team.id || ''}</td>
                <td><strong>${team.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong></td>
                <td><span class="badge ${(team.score || 0) >= 100 ? 'badge-success' : 'badge-warning'}">${team.score || 0}</span></td>
                <td><code>${team.code || ''}</code></td>
                <td>
                    <button onclick="editTeam(${team.id})" class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="addPointsToTeam(${team.id})" class="btn btn-success" style="padding: 5px 10px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
            const option = `<option value="${team.id}">${team.name} (${team.score || 0} –±–∞–ª–ª–æ–≤)</option>`;
            quickSelect.innerHTML += option;
            manualSelect.innerHTML += option;
        });
    }

    function updateRecentTransactions(transactions) {
        const tbody = document.getElementById('recentTransactions');
        
        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>';
            return;
        }
        
        let html = '';
        
        transactions.slice(0, 10).forEach(trans => {
            const time = trans.timestamp ? 
                new Date(trans.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '--:--';
            
            const team = currentState.allTeams.find(t => t.id == trans.teamId);
            const teamName = team ? team.name : `ID: ${trans.teamId}`;
            
            html += `
                <tr>
                    <td>${time}</td>
                    <td>${teamName}</td>
                    <td><span class="badge ${trans.points > 0 ? 'badge-success' : 'badge-danger'}">${trans.points > 0 ? '+' : ''}${trans.points || 0}</span></td>
                    <td>${trans.reason || ''}</td>
                    <td>${trans.moderator || ''}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    // ================= –û–ü–ï–†–ê–¶–ò–ò –û–†–ì–ê–ù–ò–ó–ê–¢–û–†–ê =================
    function quickAddPoints(points, reason) {
        const teamId = document.getElementById('quickTeamSelect').value;
        
        if (!teamId) {
            showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'warning');
            return;
        }
        
        document.getElementById('manualTeamSelect').value = teamId;
        document.getElementById('pointsInput').value = points;
        document.getElementById('reasonInput').value = reason;
        
        manualAddPoints();
    }

    async function manualAddPoints() {
        const teamId = document.getElementById('manualTeamSelect').value;
        const points = parseInt(document.getElementById('pointsInput').value);
        const reason = document.getElementById('reasonInput').value.trim();
        const moderator = document.getElementById('moderatorInput').value.trim() || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
        const password = document.getElementById('adminPassword').value;
        
        if (!teamId || isNaN(points) || !reason) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        if (!password) {
            showNotification('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            console.log('–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∫–æ–º–∞–Ω–¥–µ:', teamId, '–±–∞–ª–ª—ã:', points);
            
            const formData = new FormData();
            formData.append('action', 'addPoints');
            formData.append('teamId', teamId);
            formData.append('points', points);
            formData.append('reason', reason);
            formData.append('moderator', moderator);
            formData.append('password', password);
            
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const result = await response.json();
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:', result);
            
            if (result.success) {
                showNotification(result.data?.message || '–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è
                document.getElementById('pointsInput').value = '';
                document.getElementById('reasonInput').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                loadAdminData();
            } else {
                showNotification(result.data?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function showAddTeamModal() {
        document.getElementById('addTeamModal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function editTeam(teamId) {
        const team = currentState.allTeams.find(t => t.id == teamId);
        if (team) {
            document.getElementById('newTeamName').value = team.name || '';
            document.getElementById('newTeamCode').value = team.code || '';
            document.getElementById('newTeamContact').value = team.contact || '';
            document.getElementById('addTeamModal').classList.add('active');
        }
    }

    function addPointsToTeam(teamId) {
        const select = document.getElementById('quickTeamSelect');
        const option = Array.from(select.options).find(opt => opt.value == teamId);
        
        if (option) {
            select.value = teamId;
            showNotification(`–í—ã–±—Ä–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: ${option.text}`, 'info');
        } else {
            showNotification('–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ', 'error');
        }
    }

    // ================= –£–¢–ò–õ–ò–¢–´ =================
    function showScreen(screenId) {
        console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω:', screenId);
        
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
        } else {
            console.error('–≠–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω:', screenId);
        }
    }

    function showNotification(message, type = 'info') {
        console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', type, message);
        
        const notification = document.getElementById('notification');
        if (!notification) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    function showLoading(show) {
        if (show) {
            document.body.style.cursor = 'wait';
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä
        } else {
            document.body.style.cursor = 'default';
        }
    }

    function refreshData() {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
        
        if (currentState.team) {
            loadTeamData();
            showNotification('–î–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        } else if (currentState.isAdmin) {
            loadAdminData();
            showNotification('–î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º:', CONFIG.REFRESH_INTERVAL);
        
        window.refreshInterval = setInterval(() => {
            refreshData();
        }, CONFIG.REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
        if (window.refreshInterval) {
            clearInterval(window.refreshInterval);
            window.refreshInterval = null;
            console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }
    }

    // ================= PWA –§–£–ù–ö–¶–ò–ò =================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(error => {
                console.log('Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', error);
            });
        });
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.loginAsTeam = loginAsTeam;
    window.loginAsAdmin = loginAsAdmin;
    window.logout = logout;
    window.refreshData = refreshData;
    window.quickAddPoints = quickAddPoints;
    window.manualAddPoints = manualAddPoints;
    window.showAddTeamModal = showAddTeamModal;
    window.closeModal = closeModal;
    window.addPointsToTeam = addPointsToTeam;
    window.editTeam = editTeam;
</script>

